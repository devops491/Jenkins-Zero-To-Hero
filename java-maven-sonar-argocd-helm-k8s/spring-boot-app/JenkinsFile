pipeline {
    agent any

    environment {
        SONARQUBE = 'SonarQube'   // Name in Jenkins
        MAVEN_HOME = tool 'Maven' // Maven configured in Jenkins
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/devops491/Jenkins-Zero-To-Hero.git'
            }
        }

        stage('Build Maven Project') {
            steps {
                dir('spring-boot-app') {
                    sh "${MAVEN_HOME}/bin/mvn clean package -DskipTests"
                }
            }
        }

        stage('Unit Tests') {
            steps {
                dir('spring-boot-app') {
                    sh "${MAVEN_HOME}/bin/mvn test"
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                dir('spring-boot-app') {
                    withSonarQubeEnv('SonarQubeServer') {
                        sh "${MAVEN_HOME}/bin/mvn sonar:sonar"
                    }
                }
            }
        }

        stage('Quality Gate') {
            steps {
                waitForQualityGate abortPipeline: true
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    docker.build("durgesh296/my-app:${env.BUILD_NUMBER}")
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                withDockerRegistry([credentialsId: 'dockerhub-creds', url: '']) {
                    sh "docker tag durgesh296/my-app:${env.BUILD_NUMBER} durgesh296/my-app:${env.BUILD_NUMBER}"
                    sh "docker push durgesh296/my-app:${env.BUILD_NUMBER}"
                }
            }
        }

        stage('Update Kubernetes Manifest') {
            steps {
                sh "sed -i 's|durgesh296/my-app:.*|durgesh296/my-app:${env.BUILD_NUMBER}|' k8s/deployment.yaml"
                sh "git add k8s/deployment.yaml && git commit -m 'Update image tag to build ${env.BUILD_NUMBER}' || echo 'No changes to commit'"
                sh "git push origin main || echo 'Push failed, skipping'"
            }
        }

        stage('Deploy via ArgoCD') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'argocd-creds', usernameVariable: 'ARGO_USER', passwordVariable: 'ARGO_PASS')]) {
                    sh """
                    argocd login localhost:8082 --username $ARGO_USER --password $ARGO_PASS --insecure
                    argocd app sync my-app
                    """
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                sh "kubectl rollout status deployment/my-app"
            }
        }
    }

    post {
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed. Check logs for errors.'
        }
    }
}
